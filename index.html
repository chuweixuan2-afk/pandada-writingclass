<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ½˜å“’å“’ä¹¦æ³•è¯¾</title>
    
    <style>
        /* ================= 0. å…¨å±€åŸºç¡€ ================= */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { 
            margin: 0; padding: 0; 
            background-color: #F5F1E8; 
            font-family: "PingFang SC", "Microsoft YaHei", "KaiTi", sans-serif; 
            height: 100vh; overflow: hidden; 
            color: #3E2723; 
        }

        /* ================= 1. æ¬¢è¿é¡µæ ·å¼ ================= */
        #welcome-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #FFF8E1 0%, #FFE0B2 100%);
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            text-align: center;
            z-index: 9999; 
            transition: opacity 0.8s ease;
        }

        .logo-box {
            position: relative; margin-bottom: 40px;
            cursor: pointer; transition: transform 0.2s;
        }
        .logo-box:active { transform: scale(0.95); }

        .welcome-logo { 
            width: 180px; height: 180px; object-fit: contain; 
            position: relative; z-index: 2;
            animation: float 3s ease-in-out infinite; 
        }

        .logo-glow {
            position: absolute; top: 50%; left: 50%;
            width: 150px; height: 150px;
            background: radial-gradient(circle, rgba(255, 167, 38, 0.5) 0%, rgba(255,255,255,0) 70%);
            transform: translate(-50%, -50%);
            animation: breathe-glow 3s infinite ease-in-out;
            z-index: 1;
        }

        .voice-tip {
            position: absolute; top: -15px; right: -35px;
            background: #fff; padding: 6px 12px; border-radius: 20px;
            font-size: 13px; color: #E65100; font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: bounce 2s infinite; 
            z-index: 3; pointer-events: none;
        }
        .voice-tip::after {
            content:''; position:absolute; bottom:-6px; left:15px;
            border-width:6px 6px 0; border-style:solid; border-color:#fff transparent transparent;
        }

        .welcome-title { 
            font-size: 38px; color: #E65100; font-weight: 900; 
            margin-bottom: 12px; letter-spacing: 3px; 
            text-shadow: 2px 2px 0px rgba(255,255,255,0.6);
            opacity: 0; animation: slideUp 0.8s ease-out 0.2s forwards;
        }
        .welcome-slogan { 
            font-size: 18px; color: #8D6E63; margin-bottom: 60px; 
            font-weight: bold; letter-spacing: 1px;
            opacity: 0; animation: slideUp 0.8s ease-out 0.4s forwards;
        }

        .btn-start {
            background: linear-gradient(to right, #FF9800, #EF6C00);
            color: white; border: none; padding: 16px 80px;
            font-size: 22px; border-radius: 50px; font-weight: bold;
            box-shadow: 0 10px 25px rgba(239, 108, 0, 0.35);
            cursor: pointer; transition: transform 0.1s;
            position: relative; overflow: hidden;
            opacity: 0; animation: scaleIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.6s forwards;
        }
        .btn-start:active { transform: scale(0.95); }
        .btn-start::after {
            content: ''; position: absolute; top: 0; left: -100%;
            width: 50%; height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);
            transform: skewX(-25deg); animation: shine 3s infinite;
        }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes breathe-glow { 0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; } 50% { transform: translate(-50%, -50%) scale(1.6); opacity: 0.8; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes shine { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }


        /* ================= 2. æ ¸å¿ƒä¸šåŠ¡æ ·å¼ ================= */
        .app-screen { 
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; 
            display: none; 
            flex-direction: column !important; 
        }
        
        .panda-icon { width: 60px; height: 60px; object-fit: contain; }
        .panda-lg { width: 140px; height: 140px; object-fit: contain; }

        @keyframes breathe {
            0% { transform: scale(1); color: #333; }
            50% { transform: scale(1.08); color: #d35400; }
            100% { transform: scale(1); color: #333; }
        }
        .breathe { animation: breathe 3s infinite ease-in-out; position: relative; z-index: 10; }

        @keyframes paw-move {
            0%, 100% { transform: translateY(0) rotate(10deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }
        #teaching-paw {
            display: none; position: absolute; bottom: -20px; right: -20px;
            width: 60px; z-index: 20; pointer-events: none;
            animation: paw-move 1.5s infinite ease-in-out;
        }

        @keyframes breathe-panda {
            0% { transform: scale(0.95); opacity: 0.9; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.9; }
        }
        .thinking-anim { animation: breathe-panda 1.5s infinite ease-in-out; }

        .cheer-panda {
            position: absolute; right: -5px; top: -55px; width: 90px;
            transform: rotate(10deg); z-index: 5; pointer-events: none;
        }

        .posture-text-top {
            position: absolute; top: 13%; left: 0; width: 100%; text-align: center;
            color: #FFD700; font-size: 20px; font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8); z-index: 60; letter-spacing: 1px;
        }
        .posture-guide {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            width: 260px; height: 350px; border: 4px dashed #FF9800;
            border-radius: 150px 150px 0 0; box-shadow: 0 0 0 1000px rgba(0,0,0,0.6); z-index: 50;
        }
        .posture-tips-box {
            position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
            width: 85%; background: rgba(255, 255, 255, 0.95);
            border-radius: 12px; padding: 15px; border: 2px solid #FFCC80;
            z-index: 60; font-size: 15px; color: #5D4037; font-weight: bold;
            line-height: 1.6; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .posture-panda-icon { position: absolute; top: -45px; left: -10px; width: 70px; transform: rotate(-10deg); }

        .study-container { 
            width: 100%; flex: 1; display: flex; flex-direction: column; align-items: center; 
            background: #FFF8E1; padding-top: 40px; overflow-y: auto; padding-bottom: 120px; 
        }
        .lesson-panda { position: absolute; top: -45px; right: 10px; width: 70px; transform: rotate(10deg); }
        .prep-tips { 
            width: 90%; margin-top: 25px; background: rgba(255, 255, 255, 0.6); 
            border-radius: 10px; padding: 12px; font-size: 13px; color: #5D4037; 
            line-height: 1.6; border: 1px solid #EFEBE9; position: relative; 
        }
        .hint-card { 
            background: #FFF3E0; padding: 12px 20px; border-radius: 12px; margin-top: 10px; 
            color: #E65100; font-size: 15px; text-align: center; width: 90%; 
            border: 1px dashed #FFB74D; display: flex; flex-direction: column; justify-content: center; 
        }

        .scan-hint-box {
            position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
            display: flex; justify-content: center; align-items: center; 
            background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 30px; 
            z-index: 60; width: 80%; overflow: visible;
        }
        .scan-hint-text { color: white; font-size: 15px; font-weight: bold; text-align: center; width: 100%; }
        .scan-panda-icon { position: absolute; right: -10px; top: -35px; width: 60px; transform: rotate(15deg); }
        .scan-overlay-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 150px; height: 150px; border: 3px solid #FFD700;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.7); z-index: 50;
            display: flex; justify-content: center; align-items: center;
        }
        #ghost-char {
            width: 100%; height: 100%; display: flex; justify-content: center; 
            align-items: center; opacity: 0.6; color: red; font-size: 85px; font-family: 'KaiTi';
        }

        .adjust-box { width: 200px; height: 200px; border: 2px solid #FFD700; overflow: hidden; background: #fff; margin-bottom: 20px; position: relative; }
        #adjust-img { position: absolute; top: 50%; left: 50%; width: 100%; height: 100%; object-fit: cover; transform: translate(-50%, -50%); opacity: 0.7; }
        .adjust-overlay { position: absolute; width: 100%; height: 100%; pointer-events: none; display: flex; justify-content: center; align-items: center; top: 0; left: 0; }
        .adjust-text { font-family: 'KaiTi'; font-size: 120px; color: #e74c3c; opacity: 0.6; transform-origin: center center; }
        .controls { width: 90%; color: white; display: flex; flex-direction: column; gap: 15px; position: relative; }
        .range-wrap { display: flex; align-items: center; justify-content: space-between; font-size: 16px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 15px; }
        input[type=range] { -webkit-appearance: none; width: 65%; height: 8px; background: rgba(255,255,255,0.3); border-radius: 5px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 35px; height: 35px; border-radius: 50%; background: #FF9500; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.4); border: 3px solid white; }
        .controls-hint-box { display: flex; justify-content: center; align-items: center; margin-top: 15px; gap: 5px; }
        .controls-hint-text { font-size:18px; font-weight:800; color:#FFD700; text-shadow: 0 2px 4px rgba(0,0,0,0.9); letter-spacing: 1px; }
        .controls-panda-icon { width: 45px; height: auto; transform: rotate(-10deg); }

        #home-screen { padding: 20px; overflow-y: auto; }
        .home-header { margin-bottom: 20px; text-align: center; }
        .app-title { font-size: 28px; color: #E65100; font-weight: 800; letter-spacing: 2px; }
        .app-subtitle { font-size: 14px; color: #8D6E63; margin-top: 5px; }
        .course-list { display: flex; flex-direction: column; gap: 15px; padding-bottom: 40px; }
        .course-card { 
            background: #fff; border-radius: 16px; padding: 15px 20px; 
            box-shadow: 0 4px 12px rgba(230, 81, 0, 0.08); border-left: 6px solid #FF9800; 
            cursor: pointer; transition: transform 0.1s; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .course-idx { font-size: 32px; font-weight: bold; color: #FFE0B2; margin-right: 15px; font-family: 'Arial'; }
        .course-info { flex: 1; }
        .course-title { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px; }
        .course-desc { font-size: 12px; color: #999; line-height: 1.4; } 
        .course-arrow { color: #FFCC80; font-size: 20px; }

        .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px; overflow-y: auto; flex: 1; }
        .char-card { 
            background: #fff; aspect-ratio: 1; border-radius: 12px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            border: 2px solid #FFE0B2; position: relative; cursor: pointer; 
        }
        .char-card-text { font-family: 'KaiTi'; font-size: 42px; color: #333; }
        .char-card-pinyin { font-size: 12px; color: #888; margin-bottom: -5px; }
        .mi-grid { position: absolute; width: 80%; height: 80%; border: 1px dashed #FFCC80; pointer-events: none; }
        .mi-grid::before { content:''; position:absolute; top:50%; width:100%; height:1px; background:#FFCC80; }
        .mi-grid::after { content:''; position:absolute; left:50%; height:100%; width:1px; background:#FFCC80; }

        .video-box { 
            width: 90%; height: 180px; background: #000; border-radius: 10px; border: 3px solid #FFCC80; 
            overflow: hidden; margin-bottom: 10px; display: flex; justify-content: center; align-items: center; flex-shrink: 0;
            position: relative; 
        }
        .video-box video { width: 100%; height: 100%; object-fit: contain; }
        .tian-zi-ge { width: 160px; height: 160px; border: 3px solid #e74c3c; background: #fff; position: relative; flex-shrink: 0; }
        .line-h { position: absolute; top: 50%; width: 100%; border-top: 1px dashed #e74c3c; }
        .line-v { position: absolute; left: 50%; height: 100%; border-left: 1px dashed #e74c3c; }
        .char-display { font-family: 'KaiTi'; font-size: 130px; line-height: 160px; text-align: center; width: 100%; height: 100%; position: absolute; }
        
        .nav-bar { display: flex; align-items: center; padding: 15px; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10; width: 100%; flex-shrink: 0; }
        .nav-back { font-size: 24px; padding: 0 15px 0 5px; color: #555; cursor: pointer; }
        .nav-title { font-size: 18px; font-weight: bold; flex: 1; text-align: center; padding-right: 40px; }
        .btn-main { position: absolute; bottom: 30px; background: linear-gradient(to right, #FF9500, #FF5E3A); color: white; padding: 12px 40px; border-radius: 50px; border: none; font-size: 18px; font-weight: bold; box-shadow: 0 5px 15px rgba(255, 94, 58, 0.4); z-index: 50; cursor: pointer; }
        
        .final-frame { width: 200px; height: 200px; border: 8px solid #FFB74D; border-radius: 4px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); overflow: hidden; position: relative; margin: 20px 0; background: #fff; }
        #final-img { position: absolute; top: 50%; left: 50%; width: 100%; height: 100%; object-fit: cover; transform: translate(-50%, -50%); }
        .comment-bubble { background: #fff; padding: 20px; border-radius: 15px; border: 2px solid #FFCC80; width: 90%; position: relative; margin-top: 10px; }
        .comment-bubble::before { content:''; position:absolute; top:-10px; left:50%; transform:translateX(-50%); border-width:0 10px 10px 10px; border-style:solid; border-color:transparent transparent #FFCC80 transparent; }
        .stamp { position: absolute; bottom: 20px; right: 20px; width: 100px; height: 100px; border: 3px solid #D32F2F; border-radius: 50%; color: #D32F2F; font-size: 18px; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; transform: rotate(-20deg); opacity: 0; background: rgba(255, 255, 255, 0.8); box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.2); }
        .stamp.show { animation: stampIn 0.5s ease-out forwards; }
        
        #ai-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 248, 225, 0.95); z-index: 999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #confirm-modal { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal-box { background: white; width: 80%; border-radius: 20px; padding: 20px; text-align: center; }
        .modal-btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .btn-cancel { flex:1; padding: 10px; background: #ddd; border-radius: 25px; border:none; font-weight: bold; }
        .btn-ok { flex:1; padding: 10px; background: #FF9800; color: white; border-radius: 25px; border:none; font-weight: bold; }

        .step-section { display: none; width: 100%; height: 100%; flex-direction: column !important; align-items: center; position: absolute; top:0; left:0; }
        .step-section.active { display: flex !important; }
        #step-1, #step-scan, #step-adjust { justify-content: center; }
        #step-2, #step-report { justify-content: flex-start; }
    </style>
</head>
<body>

    <audio id="audio-voice" src="audio/voice.mp3" preload="auto"></audio>
    <audio id="audio-bgm" src="audio/bgm.mp3" preload="auto" loop></audio>

    <div id="welcome-screen">
        <div class="logo-box" onclick="playDualAudio()">
            <div class="logo-glow"></div>
            <img src="images/panda_welcome.png" class="welcome-logo" alt="æ½˜å“’å“’">
            <div class="voice-tip" id="voice-hint">ç‚¹æˆ‘å¬è¯­éŸ³ ğŸ”Š</div>
        </div>
        
        <div class="welcome-title">æ½˜å“’å“’ä¹¦æ³•è¯¾</div>
        <div class="welcome-slogan">å†™å¥½ä¸­å›½å­— Â· æ¯è¯¾ä¸€ç»ƒ</div>
        
        <button class="btn-start" onclick="enterApp()">å¼€å§‹ç»ƒå­—</button>
    </div>

    <div id="ai-loading">
        <img src="images/panda_thinking.png" class="panda-lg thinking-anim">
        <div class="loading-text" style="margin-top:20px; color:#E65100; font-weight:bold; font-size:18px;">æ½˜å“’å“’æ­£åœ¨æƒ³è¯„è¯­...</div>
        <div style="font-size:12px; color:#999; margin-top:10px;">çœ‹çœ‹ä½ çš„ç¬”é”‹æœ‰æ²¡æœ‰åˆ°ä½~</div>
    </div>

    <div id="confirm-modal">
        <div class="modal-box">
            <h3 style="color:#E65100; margin-top:0;">ğŸ¼ æ½˜å“’å“’é—®ä½ </h3>
            <p style="color:#666; font-size:14px;">å­—åœ¨æ¡†æ¡†æ­£ä¸­é—´å—ï¼Ÿ<br>èƒ½ä¸èƒ½çœ‹æ¸…æ¥šï¼Ÿ</p>
            <div class="modal-btn-row">
                <button class="btn-cancel" onclick="closeModal()">ä¸æ¸…æ¥šï¼Œé‡æ‹</button>
                <button class="btn-ok" onclick="confirmAndReport()">çœ‹æ¸…äº†ï¼Œæäº¤ï¼</button>
            </div>
        </div>
    </div>

    <div id="home-screen" class="app-screen">
        <div class="home-header">
            <div style="display:flex; justify-content:center; align-items:center; gap:5px;">
                <div class="app-title">æ½˜å“’å“’ä¹¦æ³•è¯¾</div>
                <img src="images/panda_welcome.png" class="panda-icon">
            </div>
            <div class="app-subtitle">ä¸€å¹´çº§ä¸‹å†Œ Â· è§„èŒƒä¹¦å†™</div>
        </div>
        <div class="course-list" id="course-list"></div>
    </div>

    <div id="level-screen" class="app-screen">
        <div class="nav-bar"><div class="nav-back" onclick="navigateTo('home-screen')">â®</div><div class="nav-title" id="level-title">è¯¾ç¨‹è¯¦æƒ…</div></div>
        <div class="char-grid" id="char-list"></div>
    </div>

    <div id="practice-screen" class="app-screen">
        <div id="step-1" class="step-section active">
            <div class="nav-bar" style="position:absolute;top:0;background:transparent;box-shadow:none;"><div class="nav-back" style="color:white;background:rgba(0,0,0,0.3);border-radius:50%;width:30px;height:30px;text-align:center;padding:0;" onclick="navigateTo('level-screen')">âœ•</div></div>
            <div class="camera-box">
                <video id="video-front" class="mirror" autoplay playsinline muted></video>
                <div class="posture-text-top">è¯·å°†å¤´æ­£å¯¹è™šæ¡†å†…</div>
                <div class="posture-guide"></div>
                <div class="posture-tips-box">
                    <img src="images/panda_posture.png" class="posture-panda-icon">
                    <div style="font-weight:bold; color:#E65100; margin-bottom:5px;">ğŸ“ æ½˜å“’å“’å¥½ä¹ æƒ¯ï¼š</div>
                    <div>æ‰‹ç¦»ç¬”å°–ä¸€æŒ‡èŠ‚<br>çœ¼ç¦»çº¸æœ¬ä¸€å°è‡‚<br>èƒ¸ç¦»æ¡Œè¾¹ä¸€å°æ‹³</div>
                </div>
            </div>
            <button class="btn-main" onclick="startPractice()">âœ… åå¥½äº†</button>
        </div>

        <div id="step-2" class="step-section" style="background:#FFF8E1;">
            <div class="nav-bar"><div class="nav-back" onclick="navigateTo('level-screen')">â®</div><div class="nav-title">è·Ÿç€æ½˜å“’å“’å†™</div></div>
            <div class="study-container">
                <div class="video-box">
                    <video id="study-video" src="" controls loop playsinline preload="none"></video>
                    <img id="teaching-paw" src="images/panda_welcome.png">
                </div>
                
                <div class="tian-zi-ge">
                    <div class="line-h"></div><div class="line-v"></div>
                    <div class="char-display breathe" id="study-char">?</div>
                </div>
                
                <div class="hint-card">
                    <div style="font-weight:bold; margin-bottom:5px;">ğŸ’¡ æœ¬è¯¾é‡ç‚¹ï¼š</div>
                    <span id="lesson-rule-hint" style="color:#5D4037;">...</span>
                </div>
                
                <div class="prep-tips">
                    <img src="images/panda_lesson.png" class="lesson-panda">
                    <div style="font-weight:bold; margin-bottom:5px; color:#E65100;">ğŸ“ ç»ƒä¹ å°è´´å£«ï¼š</div>
                    <div style="margin-bottom:4px;">1. è¯·åœ¨ä¹¦ä¸Š<b id="tip-practice-place">â€œæˆ‘èƒ½è‡ªå·±ç»ƒâ€</b>çš„ç”°å­—æ ¼é‡Œç»ƒä¹ ï¼Œæ–¹ä¾¿åç»­è¯„ä»·ã€‚</div>
                    <div style="margin-bottom:4px;">2. ç»ƒä¹ ä¹‹å‰å…ˆæ£€æŸ¥è‡ªå·±çš„<b>åŒæ‰‹æ˜¯å¦å¹²å‡€</b>ï¼Œ<b>æ¡Œé¢æ˜¯å¦æ•´æ´</b>ï¼Œç„¶åå†å†™å­—ã€‚</div>
                    <div>3. ä¿æŒæ­£ç¡®<b>æ¡ç¬”å§¿åŠ¿</b>ï¼šå†™å­—æ—¶æ‰§ç¬”å§¿åŠ¿è¦æ­£ç¡®ï¼Œ<b>å¤§æ‹‡æŒ‡ä¸èƒ½å‹é£ŸæŒ‡</b>ã€‚</div>
                </div>
                <button class="btn-main" onclick="goToScan()">ğŸ“¸ ç»ƒå¥½äº†ï¼Œå»æ‹ç…§</button>
            </div>
        </div>

        <div id="step-scan" class="step-section">
            <div class="nav-bar" style="position:absolute;top:0;width:100%;background:transparent;box-shadow:none;z-index:70;">
                <div class="nav-back" style="color:white;background:rgba(0,0,0,0.3);border-radius:50%;width:30px;height:30px;text-align:center;padding:0;line-height:30px;" onclick="backToPractice()">â®</div>
            </div>
            <div class="camera-box">
                <video id="video-back" autoplay playsinline muted></video>
                <div class="scan-overlay-box">
                    <div style="width:150px;height:150px;display:flex;justify-content:center;align-items:center;opacity:0.6;color:red;font-size:85px;font-family:'KaiTi';" id="ghost-char">?</div>
                </div>
                <div class="scan-hint-box">
                    <div class="scan-hint-text">å¯¹å‡†ç”°å­—æ ¼é‡Œçš„å­—ï¼Œå’”åš“ä¸€ä¸‹ï¼</div>
                    <img src="images/panda_welcome.png" class="scan-panda-icon">
                </div>
            </div>
            <button class="btn-main" onclick="capture()">ğŸ“¸ å’”åš“</button>
        </div>

        <div id="step-adjust" class="step-section" style="background:#222;">
            <div class="adjust-box">
                <img id="adjust-img" src="">
                <div class="adjust-overlay"><div class="adjust-text" id="adjust-char-overlay">?</div></div>
            </div>
            <div class="controls">
                <div class="controls-hint-box">
                    <img src="images/panda_posture.png" class="controls-panda-icon">
                    <div class="controls-hint-text">æ‹–åŠ¨æ»‘æ†ï¼ŒæŠŠçº¢å­—å’Œä½ çš„å­—å¯¹é½</div>
                </div>
                <div class="range-wrap"><span>ğŸ–¼ï¸ å›¾ç‰‡</span><input type="range" min="0.5" max="2.5" step="0.05" value="1" id="scale-img" oninput="updateAdjust()"></div>
                <div class="range-wrap"><span>ğŸ”  çº¢å­—</span><input type="range" min="0.5" max="1.5" step="0.05" value="1" id="scale-text" oninput="updateAdjust()"></div>
            </div>
            <button class="btn-main" onclick="checkQualityAndConfirm()" style="bottom:50px;">âœ¨ æäº¤ä½œå“</button>
        </div>

        <div id="step-report" class="step-section" style="background:#FFF8E1;overflow-y:auto;justify-content:flex-start;">
            <div class="nav-bar"><div class="nav-back" onclick="navigateTo('level-screen')">â®</div><div class="nav-title">å°å°ä¹¦æ³•å®¶</div></div>
            <div class="final-frame"><img id="final-img" src=""></div>
            <div class="stamp">
                <img src="images/panda_avatar.png" style="width:50px; opacity:0.9; margin-bottom:5px;">
                <div style="font-size:14px; color:#D32F2F; margin-top:-5px;">ä¼˜ç§€</div>
            </div>
            <div class="comment-bubble">
                <img src="images/panda_success.png" class="cheer-panda">
                <div style="text-align:center;font-size:24px;color:#FFD700;margin-bottom:5px;">â˜…â˜…â˜…â˜…â˜†</div>
                <div style="font-size:14px;color:#555;line-height:1.6;" id="ai-comment">...</div>
            </div>
            <button class="btn-main" style="position:static;margin-top:20px;margin-bottom:40px;" onclick="navigateTo('level-screen')">ğŸ å®Œæˆï¼Œç»ƒä¸‹ä¸€ä¸ª</button>
        </div>
    </div>

    <canvas id="cvs" style="display:none;"></canvas>
    <canvas id="analysis-cvs" style="display:none;" width="100" height="100"></canvas>

    <!-- ç»Ÿä¸€è¯„è¯­åº“ä¸æ™ºèƒ½è¯„è¯­é€»è¾‘ -->
    <script src="comment-db.js"></script>

    <script>
        window.onerror = function(msg, url, line) { return false; };

        // ================= ğŸ”Š A. æ¬¢è¿é¡µéŸ³è§†é¢‘é€»è¾‘ (æ‰‹æœºå…¼å®¹ç‰ˆ) =================
        function playDualAudio() {
            var voice = document.getElementById('audio-voice');
            var bgm = document.getElementById('audio-bgm');
            var hint = document.getElementById('voice-hint');

            if(hint) hint.style.display = 'none';

            stopWelcomeAudio(); // å…ˆé‡ç½®

            voice.volume = 1.0; 
            bgm.volume = 0.15; 

            var p1 = voice.play();
            var p2 = bgm.play();

            if (p1 !== undefined) p1.catch(e => console.error("Voice error:", e));
            if (p2 !== undefined) p2.catch(e => console.error("BGM error:", e));
        }

        // ğŸ”§ å¼ºåˆ¶åœæ­¢å·¥å…·å‡½æ•°
        function stopWelcomeAudio() {
            var voice = document.getElementById('audio-voice');
            var bgm = document.getElementById('audio-bgm');
            if (voice) { voice.pause(); voice.currentTime = 0; }
            if (bgm) { bgm.pause(); bgm.currentTime = 0; }
        }

        function enterApp() {
            var screen = document.getElementById('welcome-screen');
            screen.style.opacity = '0';
            
            stopWelcomeAudio(); // ç«‹å³åœæ­¢

            setTimeout(function() {
                screen.style.display = 'none';
                document.getElementById('home-screen').style.display = 'flex';
                renderHome(); 
                startCam('video-front', 'user');
            }, 800); 
        }

        var streamObj = null;
        var currentActiveChar = null;
        var currentActiveCourse = null;
        var startTime = 0; 

        // ğŸ“¦ è¯¾ç¨‹æ•°æ®åº“
        const COURSE_DATA = [
            // === ä¸€å¹´çº§å†…å®¹ ===
            { id: 1, grade: 1, title: "ç¬¬ä¸€è¯¾ åŸºæœ¬ç¬”ç”»ç»ƒä¹ ", rule_desc: "çŸ­æ¨ªã€çŸ­ç«–", chars: [ { char: "æ˜¥", pinyin: "chÅ«n", video: "videos/æ˜¥.mp4" }, { char: "é’", pinyin: "qÄ«ng", video: "videos/é’.mp4" }, { char: "å½“", pinyin: "dÄng", video: "videos/å½“.mp4" }, { char: "å…±", pinyin: "gÃ²ng", video: "videos/å…±.mp4" }, { char: "å…ƒ", pinyin: "yuÃ¡n", video: "videos/å…ƒ.mp4" }, { char: "æ­¢", pinyin: "zhÇ", video: "videos/æ­¢.mp4" }, { char: "ä»–", pinyin: "tÄ", video: "videos/ä»–.mp4" } ] },
            { id: 2, grade: 1, title: "ç¬¬äºŒè¯¾ ç¬”é¡ºè§„åˆ™æŒæ¡", rule_desc: "å…ˆå¤–åå†…å†å°å£", chars: [ { char: "å›", pinyin: "huÃ­", video: "videos/å›.mp4" }, { char: "æ—¥", pinyin: "rÃ¬", video: "videos/æ—¥.mp4" }, { char: "ç›®", pinyin: "mÃ¹", video: "videos/ç›®.mp4" }, { char: "è‡ª", pinyin: "zÃ¬", video: "videos/è‡ª.mp4" }, { char: "ç”°", pinyin: "tiÃ¡n", video: "videos/ç”°.mp4" }, { char: "å››", pinyin: "sÃ¬", video: "videos/å››.mp4" }, { char: "ç™½", pinyin: "bÃ¡i", video: "videos/ç™½.mp4" } ] },
            { id: 3, grade: 1, title: "ç¬¬ä¸‰è¯¾ åŸºæœ¬ç¬”ç”»ç»ƒä¹ ", rule_desc: "æ¨ªæŠ˜å¼¯ã€æ¨ªæŠ˜æŠ˜æ’‡ã€æ¨ªæ’‡å¼¯é’©", chars: [ { char: "æ²¡", pinyin: "mÃ©i", video: "videos/æ²¡.mp4" }, { char: "é€ ", pinyin: "zÃ o", video: "videos/é€ .mp4" }, { char: "è¿œ", pinyin: "yuÇn", video: "videos/è¿œ.mp4" }, { char: "é˜Ÿ", pinyin: "duÃ¬", video: "videos/é˜Ÿ.mp4" }, { char: "æœµ", pinyin: "duÇ’", video: "videos/æœµ.mp4" }, { char: "è¿", pinyin: "yÃ¹n", video: "videos/è¿.mp4" } ] },
            { id: 4, grade: 1, title: "ç¬¬å››è¯¾ åŸºæœ¬ç¬”ç”»ç»ƒä¹ ", rule_desc: "æ¨ªæ–œé’©ã€æ¨ªæŠ˜æ", chars: [ { char: "é£", pinyin: "fÄ“i", video: "videos/é£.mp4" }, { char: "è¯·", pinyin: "qÇng", video: "videos/è¯·.mp4" }, { char: "è¯", pinyin: "zhÃ¨ng", video: "videos/è¯.mp4" }, { char: "è¯†", pinyin: "shÃ­", video: "videos/è¯†.mp4" }, { char: "æ°”", pinyin: "qÃ¬", video: "videos/æ°”.mp4" }, { char: "è®¤", pinyin: "rÃ¨n", video: "videos/è®¤.mp4" }, { char: "è®©", pinyin: "rÃ ng", video: "videos/è®©.mp4" } ] },
            { id: 5, grade: 1, title: "ç¬¬äº”è¯¾ åŸºæœ¬ç¬”ç”»ç»ƒä¹ ", rule_desc: "å·¦ç‚¹ã€å³ç‚¹", chars: [ { char: "å°–", pinyin: "jiÄn", video: "videos/å°–.mp4" }, { char: "ç±³", pinyin: "mÇ", video: "videos/ç±³.mp4" }, { char: "å¹¿", pinyin: "guÇng", video: "videos/å¹¿.mp4" }, { char: "ä¸º", pinyin: "wÃ¨i", video: "videos/ä¸º.mp4" }, { char: "å¤–", pinyin: "wÃ i", video: "videos/å¤–.mp4" }, { char: "å…´", pinyin: "xÃ¬ng", video: "videos/å…´.mp4" }, { char: "å¹³", pinyin: "pÃ­ng", video: "videos/å¹³.mp4" } ] },
            { id: 6, grade: 1, title: "ç¬¬å…­è¯¾ ç¬”é¡ºè§„åˆ™æŒæ¡", rule_desc: "ç‚¹çš„å…ˆå†™å’Œåå†™", chars: [ { char: "æ²™", pinyin: "shÄ", video: "videos/æ²™.mp4" }, { char: "è®©", pinyin: "rÃ ng", video: "videos/è®©.mp4" }, { char: "å¹¿", pinyin: "guÇng", video: "videos/å¹¿.mp4" }, { char: "æ–¹", pinyin: "fÄng", video: "videos/æ–¹.mp4" } ] },
            { id: 7, grade: 1, title: "ç¬¬ä¸ƒè¯¾ åŸºæœ¬ç¬”ç”»ç»ƒä¹ ", rule_desc: "å¹³æ’‡ã€æ–œæ’‡", chars: [ { char: "è®¤", pinyin: "rÃ¨n", video: "videos/è®¤.mp4" }, { char: "ä»", pinyin: "cÃ³ng", video: "videos/ä».mp4" }, { char: "åƒ", pinyin: "qiÄn", video: "videos/åƒ.mp4" }, { char: "ç¦¾", pinyin: "hÃ©", video: "videos/ç¦¾.mp4" } ] },
            { id: 8, grade: 1, title: "ç¬¬å…«è¯¾ åŸºæœ¬ç¬”ç”»ç»ƒä¹ ", rule_desc: "ç«–æ’‡", chars: [ { char: "èƒ¡", pinyin: "hÃº", video: "videos/èƒ¡.mp4" }, { char: "è®²", pinyin: "jiÇng", video: "videos/è®².mp4" }, { char: "å¼€", pinyin: "kÄi", video: "videos/å¼€.mp4" }, { char: "ç”¨", pinyin: "yÃ²ng", video: "videos/ç”¨.mp4" }, { char: "æœˆ", pinyin: "yuÃ¨", video: "videos/æœˆ.mp4" }, { char: "çš®", pinyin: "pÃ­", video: "videos/çš®.mp4" }, { char: "äº•", pinyin: "jÇng", video: "videos/äº•.mp4" } ] },
            { id: 9, grade: 1, title: "ç¬¬ä¹è¯¾ åŸºæœ¬ç¬”ç”»ç»ƒä¹ ", rule_desc: "å¹³æº", chars: [ { char: "ä¹‹", pinyin: "zhÄ«", video: "videos/ä¹‹.mp4" }, { char: "é€ ", pinyin: "zÃ o", video: "videos/é€ .mp4" }, { char: "è¿œ", pinyin: "yuÇn", video: "videos/è¿œ.mp4" }, { char: "è¿‘", pinyin: "jÃ¬n", video: "videos/è¿‘.mp4" }, { char: "è¿˜", pinyin: "hÃ¡i", video: "videos/è¿˜.mp4" }, { char: "è¿‡", pinyin: "guÃ²", video: "videos/è¿‡.mp4" } ] },
            { id: 10, grade: 1, title: "ç¬¬åè¯¾ ç¬”é¡ºè§„åˆ™æŒæ¡", rule_desc: "å·¦ä¸ŠåŒ…å›´å’Œå³ä¸ŠåŒ…å›´", chars: [ { char: "å·¦", pinyin: "zuÇ’", video: "videos/å·¦.mp4" }, { char: "å³", pinyin: "yÃ²u", video: "videos/å³.mp4" }, { char: "çŸ³", pinyin: "shÃ­", video: "videos/çŸ³.mp4" }, { char: "æœ‰", pinyin: "yÇ’u", video: "videos/æœ‰.mp4" }, { char: "åŒ…", pinyin: "bÄo", video: "videos/åŒ….mp4" }, { char: "é¥±", pinyin: "bÇo", video: "videos/é¥±.mp4" }, { char: "æŠ±", pinyin: "bÃ o", video: "videos/æŠ±.mp4" } ] },
            // === äºŒå¹´çº§å†…å®¹ ===
            { id: 11, grade: 2, title: "ç¬¬ä¸€è¯¾ å‚å­—æ—ã€å¹¿å­—æ—ã€å°¸å­—æ—ã€æˆ·å­—æ—", rule_desc: "é‡ç‚¹ï¼šå·¦ä¸ŠåŒ…å›´ã€æ’‡ç”»èˆ’å±•", chars: [ { char: "æ„¿", pinyin: "yuÃ n", video: "videos/æ„¿.mp4" }, { char: "åº•", pinyin: "dÇ", video: "videos/åº•.mp4" }, { char: "å±…", pinyin: "jÅ«", video: "videos/å±….mp4" }, { char: "åŸ", pinyin: "yuÃ¡n", video: "videos/åŸ.mp4" }, { char: "æˆ¿", pinyin: "fÃ¡ng", video: "videos/æˆ¿.mp4" }, { char: "æ‰‡", pinyin: "shÃ n", video: "videos/æ‰‡.mp4" } ] },
            { id: 12, grade: 2, title: "ç¬¬äºŒè¯¾ æ—¥å­—æ—ã€ç›®å­—æ—ã€èˆŒå­—æ—ã€åˆå­—æ—", rule_desc: "é‡ç‚¹ï¼šå·¦å³ç»“æ„ã€å·¦çª„å³å®½", chars: [ { char: "æ˜¨", pinyin: "zuÃ³", video: "videos/æ˜¨.mp4" }, { char: "æš–", pinyin: "nuÇn", video: "videos/æš–.mp4" }, { char: "çœ¼", pinyin: "yÇn", video: "videos/çœ¼.mp4" }, { char: "ä¹±", pinyin: "luÃ n", video: "videos/ä¹±.mp4" }, { char: "è§‚", pinyin: "guÄn", video: "videos/è§‚.mp4" }, { char: "æ¬¢", pinyin: "huÄn", video: "videos/æ¬¢.mp4" } ] },
            { id: 13, grade: 2, title: "ç¬¬ä¸‰è¯¾ è´å­—æ—ã€é£Ÿå­—æ—ã€é¸Ÿå­—æ—ã€åæ–‡æ—", rule_desc: "é‡ç‚¹ï¼šå·¦å³ç»“æ„ã€ç©¿æ’é¿è®©", chars: [ { char: "è´¢", pinyin: "cÃ¡i", video: "videos/è´¢.mp4" }, { char: "è´´", pinyin: "tiÄ“", video: "videos/è´´.mp4" }, { char: "é¥­", pinyin: "fÃ n", video: "videos/é¥­.mp4" }, { char: "é¸­", pinyin: "yÄ", video: "videos/é¸­.mp4" }, { char: "æ”¾", pinyin: "fÃ ng", video: "videos/æ”¾.mp4" }, { char: "æ”¶", pinyin: "shÅu", video: "videos/æ”¶.mp4" } ] },
            { id: 14, grade: 2, title: "ç¬¬å››è¯¾ å›½å­—æ¡†ã€é—¨å­—æ¡†ã€åŒå­—æ¡†ã€ä¸‰æ¡†", rule_desc: "é‡ç‚¹ï¼šåŒ…å›´ç»“æ„ã€å¤–æ¡†ä¸å†…èŠ¯", chars: [ { char: "å›½", pinyin: "guÃ³", video: "videos/å›½.mp4" }, { char: "åŒ", pinyin: "tÃ³ng", video: "videos/åŒ.mp4" }, { char: "ç½‘", pinyin: "wÇng", video: "videos/ç½‘.mp4" }, { char: "é—­", pinyin: "bÃ¬", video: "videos/é—­.mp4" }, { char: "è‡£", pinyin: "chÃ©n", video: "videos/è‡£.mp4" } ] },
            { id: 15, grade: 2, title: "ç¬¬äº”è¯¾ å¿ƒå­—åº•ã€å››ç‚¹åº•ã€çš¿å­—åº•ã€å¼‚å­—åº•", rule_desc: "é‡ç‚¹ï¼šä¸Šç´§ä¸‹æ¾ã€ä¸‹å®½æ‰˜ä¸Š", chars: [ { char: "æ„Ÿ", pinyin: "gÇn", video: "videos/æ„Ÿ.mp4" }, { char: "çƒ­", pinyin: "rÃ¨", video: "videos/çƒ­.mp4" }, { char: "é»‘", pinyin: "hÄ“i", video: "videos/é»‘.mp4" }, { char: "ç›–", pinyin: "gÃ i", video: "videos/ç›–.mp4" }, { char: "å¼‚", pinyin: "yÃ¬", video: "videos/å¼‚.mp4" }, { char: "å¼„", pinyin: "nÃ²ng", video: "videos/å¼„.mp4" } ] },
            { id: 16, grade: 2, title: "ç¬¬å…­è¯¾ å±±å­—æ—ã€çŸ³å­—æ—ã€ç‰›å­—æ—ã€èˆŸå­—æ—", rule_desc: "é‡ç‚¹ï¼šåæ—çª„é•¿ã€æç”»é¿è®©", chars: [ { char: "å³¡", pinyin: "xiÃ¡", video: "videos/å³¡.mp4" }, { char: "ç ´", pinyin: "pÃ²", video: "videos/ç ´.mp4" }, { char: "ç ", pinyin: "kÇn", video: "videos/ç .mp4" }, { char: "ç‰¹", pinyin: "tÃ¨", video: "videos/ç‰¹.mp4" }, { char: "ç‰©", pinyin: "wÃ¹", video: "videos/ç‰©.mp4" }, { char: "èˆ¹", pinyin: "chuÃ¡n", video: "videos/èˆ¹.mp4" } ] },
            { id: 17, grade: 2, title: "ç¬¬ä¸ƒè¯¾ è™«å­—æ—ã€è½¦å­—æ—ã€ç—…å­—æ—ã€åŒ…å­—å¤´", rule_desc: "é‡ç‚¹ï¼šçª„é•¿é¿è®©ã€åŠåŒ…å›´", chars: [ { char: "è›™", pinyin: "wÄ", video: "videos/è›™.mp4" }, { char: "è½®", pinyin: "lÃºn", video: "videos/è½®.mp4" }, { char: "è½¬", pinyin: "zhuÇn", video: "videos/è½¬.mp4" }, { char: "ç—›", pinyin: "tÃ²ng", video: "videos/ç—›.mp4" }, { char: "ç–²", pinyin: "pÃ­", video: "videos/ç–².mp4" }, { char: "åŒ…", pinyin: "bÄo", video: "videos/åŒ….mp4" } ] },
            { id: 18, grade: 2, title: "ç¬¬å…«è¯¾ äº¬å­—å¤´ã€å®ç›–å¤´ã€ç©´å®ç›–ã€é›¨å­—å¤´", rule_desc: "é‡ç‚¹ï¼šä¸Šå®½ç›–ä¸‹ã€é‡å¿ƒå¯¹æ­£", chars: [ { char: "è¨€", pinyin: "yÃ¡n", video: "videos/è¨€.mp4" }, { char: "å®‡", pinyin: "yÇ”", video: "videos/å®‡.mp4" }, { char: "å®¤", pinyin: "shÃ­", video: "videos/å®¤.mp4" }, { char: "çª", pinyin: "tÅ«", video: "videos/çª.mp4" }, { char: "ç©·", pinyin: "qiÃ³ng", video: "videos/ç©·.mp4" }, { char: "é›·", pinyin: "lÃ©i", video: "videos/é›·.mp4" } ] },
            
            // === ä¸‰å¹´çº§å†…å®¹ (æ›´æ–°è‡³ç¬¬å…«è¯¾ï¼Œå¹¶ä¿ç•™9è¯¾å ä½) ===
            { 
                id: 21, 
                grade: 3, 
                title: "ç¬¬ä¸€è¯¾ ä¸‰æ’‡æ—ã€æ¬ å­—æ—ã€é¡µå­—æ—", 
                rule_desc: "é‡ç‚¹ï¼šä¸‰æ’‡åŒ€ç§°ã€å·¦çª„å³å®½", 
                chars: [ 
                    { char: "æ‰", pinyin: "shÄn", video: "videos/æ‰.mp4" }, 
                    { char: "å½±", pinyin: "yÇng", video: "videos/å½±.mp4" }, 
                    { char: "æ¬§", pinyin: "Åu", video: "videos/æ¬§.mp4" }, 
                    { char: "æ¬£", pinyin: "xÄ«n", video: "videos/æ¬£.mp4" }, 
                    { char: "é¢„", pinyin: "yÃ¹", video: "videos/é¢„.mp4" }, 
                    { char: "é¢—", pinyin: "kÄ“", video: "videos/é¢—.mp4" } 
                ] 
            },
            { 
                id: 22, 
                grade: 3, 
                title: "ç¬¬äºŒè¯¾ å­å­—æ—ã€å¼“å­—æ—ã€é©¬å­—æ—", 
                rule_desc: "é‡ç‚¹ï¼šåæ—ç˜¦é•¿ã€ç©¿æ’é¿è®©", 
                chars: [ 
                    { char: "å­”", pinyin: "kÇ’ng", video: "videos/å­”.mp4" }, 
                    { char: "å­¤", pinyin: "gÅ«", video: "videos/å­¤.mp4" }, 
                    { char: "å¼¹", pinyin: "dÃ n", video: "videos/å¼¹.mp4" }, 
                    { char: "å¼•", pinyin: "yÇn", video: "videos/å¼•.mp4" }, 
                    { char: "éªŒ", pinyin: "yÃ n", video: "videos/éªŒ.mp4" }, 
                    { char: "éª—", pinyin: "piÃ n", video: "videos/éª—.mp4" } 
                ] 
            },
            {
                id: 23,
                grade: 3,
                title: "ç¬¬ä¸‰è¯¾ é…‰å­—æ—ã€ç±³å­—æ—ã€æ–¹å­—æ—",
                rule_desc: "é‡ç‚¹ï¼šåæ—å­—å½¢ã€å·¦å³å‘¼åº”",
                chars: [
                    { char: "é…", pinyin: "pÃ¨i", video: "videos/é….mp4" },
                    { char: "é…·", pinyin: "kÃ¹", video: "videos/é…·.mp4" },
                    { char: "ç²’", pinyin: "lÃ¬", video: "videos/ç²’.mp4" },
                    { char: "æ–™", pinyin: "liÃ o", video: "videos/æ–™.mp4" },
                    { char: "æ”¾", pinyin: "fÃ ng", video: "videos/æ”¾.mp4" },
                    { char: "æ–½", pinyin: "shÄ«", video: "videos/æ–½.mp4" }
                ]
            },
            {
                id: 24,
                grade: 3,
                title: "ç¬¬å››è¯¾ æ˜¥å­—å¤´ã€å·å­—å¤´ã€çˆ¶å­—å¤´",
                rule_desc: "é‡ç‚¹ï¼šä¸Šç›–ä¸‹ã€æ’‡æºèˆ’å±•",
                chars: [
                    { char: "æ³°", pinyin: "tÃ i", video: "videos/æ³°.mp4" },
                    { char: "å¥‰", pinyin: "fÃ¨ng", video: "videos/å¥‰.mp4" },
                    { char: "æ‹³", pinyin: "quÃ¡n", video: "videos/æ‹³.mp4" },
                    { char: "çœ·", pinyin: "juÃ n", video: "videos/çœ·.mp4" },
                    { char: "çˆ¹", pinyin: "diÄ“", video: "videos/çˆ¹.mp4" },
                    { char: "æ–§", pinyin: "fÇ”", video: "videos/æ–§.mp4" }
                ]
            },
            {
                id: 25,
                grade: 3,
                title: "ç¬¬äº”è¯¾ é—´æ¶ç»“æ„çš„æ¢³ç†ä¸æ¢ç©¶5â€”â€”ä¸Šä¸‹ç»“æ„",
                rule_desc: "é‡ç‚¹ï¼šé‡å¿ƒå¯¹æ­£ã€æ”¶æ”¾è‡ªå¦‚",
                chars: [
                    { char: "å¤º", pinyin: "duÃ³", video: "videos/å¤º.mp4" },
                    { char: "å´", pinyin: "wÃº", video: "videos/å´.mp4" },
                    { char: "ç›", pinyin: "zhÇn", video: "videos/ç›.mp4" },
                    { char: "ç¬‹", pinyin: "sÇ”n", video: "videos/ç¬‹.mp4" },
                    { char: "æ‚¬", pinyin: "xuÃ¡n", video: "videos/æ‚¬.mp4" },
                    { char: "æ˜¯", pinyin: "shÃ¬", video: "videos/æ˜¯.mp4" }
                ]
            },
            {
                id: 26,
                grade: 3,
                title: "ç¬¬å…­è¯¾ é—´æ¶ç»“æ„çš„æ¢³ç†ä¸æ¢ç©¶6â€”â€”ä¸Šä¸­ä¸‹ç»“æ„",
                rule_desc: "é‡ç‚¹ï¼šéƒ¨ä»¶åŒ€ç§°ã€é‡å¿ƒå¹³ç¨³",
                chars: [
                    { char: "è’¸", pinyin: "zhÄ“ng", video: "videos/è’¸.mp4" },
                    { char: "ç­‰", pinyin: "dÄ›ng", video: "videos/ç­‰.mp4" },
                    { char: "æ€¥", pinyin: "jÃ­", video: "videos/æ€¥.mp4" },
                    { char: "ç« ", pinyin: "zhÄng", video: "videos/ç« .mp4" },
                    { char: "è‰", pinyin: "cÇo", video: "videos/è‰.mp4" },
                    { char: "æ„", pinyin: "yÃ¬", video: "videos/æ„.mp4" }
                ]
            },
            {
                id: 27,
                grade: 3,
                title: "ç¬¬ä¸ƒè¯¾ é—´æ¶ç»“æ„çš„æ¢³ç†ä¸æ¢ç©¶7â€”â€”ä¸¤é¢åŒ…å›´",
                rule_desc: "é‡ç‚¹ï¼šä¼¸ç¼©é¿è®©ã€åŒ…å›´é€‚åº¦",
                chars: [
                    { char: "å†", pinyin: "lÃ¬", video: "videos/å†.mp4" },
                    { char: "ç—•", pinyin: "hÃ©n", video: "videos/ç—•.mp4" },
                    { char: "æˆ¿", pinyin: "fÃ¡ng", video: "videos/æˆ¿.mp4" },
                    { char: "æ­¦", pinyin: "wÇ”", video: "videos/æ­¦.mp4" },
                    { char: "åŒ€", pinyin: "yÃºn", video: "videos/åŒ€.mp4" },
                    { char: "é€š", pinyin: "tÅng", video: "videos/é€š.mp4" },
                    { char: "ç¿…", pinyin: "chÃ¬", video: "videos/ç¿….mp4" }
                ]
            },
            {
                id: 28,
                grade: 3,
                title: "ç¬¬å…«è¯¾ é—´æ¶ç»“æ„çš„æ¢³ç†ä¸æ¢ç©¶8â€”â€”ä¸‰é¢åŒ…å›´ã€å…¨åŒ…å›´",
                rule_desc: "é‡ç‚¹ï¼šåŒ…å›´æ–¹æ­£ã€å†…éƒ¨å±…ä¸­",
                chars: [
                    { char: "åŒº", pinyin: "qÅ«", video: "videos/åŒº.mp4" },
                    { char: "åŒ ", pinyin: "jiÃ ng", video: "videos/åŒ .mp4" },
                    { char: "é—²", pinyin: "xiÃ¡n", video: "videos/é—².mp4" },
                    { char: "å‡¶", pinyin: "xiÅng", video: "videos/å‡¶.mp4" },
                    { char: "å¹½", pinyin: "yÅu", video: "videos/å¹½.mp4" },
                    { char: "å›°", pinyin: "kÃ¹n", video: "videos/å›°.mp4" }
                ]
            }
        ];

        // é¡µé¢é€»è¾‘å…¥å£
        function renderHome() { 
            const list = document.getElementById('course-list'); 
            if (!list) return;
            list.innerHTML = ""; 

            const urlParams = new URLSearchParams(window.location.search);
            const currentLevel = parseInt(urlParams.get('level')) || 1; 

            const titles = { 1: "ä¸€å¹´çº§ä¸‹å†Œ", 2: "äºŒå¹´çº§ä¸‹å†Œ", 3: "ä¸‰å¹´çº§ä¸‹å†Œ" };
            document.querySelector('.app-subtitle').innerText = (titles[currentLevel] || "ä¹¦æ³•ç»ƒä¹ ") + " Â· è§„èŒƒä¹¦å†™";

            const filteredCourses = COURSE_DATA.filter(c => c.grade === currentLevel);

            if (filteredCourses.length === 0) {
                list.innerHTML = "<div style='text-align:center;padding:40px;color:#999;font-size:14px;'>ğŸ¼ å“å‘€ï¼Œ<br>è¿™ä¸ªå¹´çº§çš„è¯¾è¿˜åœ¨å¤‡è¯¾ä¸­...<br>è¯·ç¨åå†æ¥ï¼</div>";
                return;
            }

            filteredCourses.forEach(function(course, idx) { 
                const div = document.createElement('div'); 
                div.className = 'course-card'; 
                div.onclick = function() { openLevel(course); }; 
                div.innerHTML = "<div style='display:flex;align-items:center;'><div class='course-idx'>" + (idx + 1) + "</div><div class='course-info'><div class='course-title'>" + course.title + "</div><div class='course-desc'>ğŸ¯ " + course.rule_desc + "</div></div></div><div class='course-arrow'>âœ</div>"; 
                list.appendChild(div); 
            }); 
        }

        function openLevel(courseObj) { 
            currentActiveCourse = courseObj;
            document.getElementById('level-title').innerText = courseObj.title.replace(/<[^>]+>/g, ' '); 
            
            const grid = document.getElementById('char-list'); 
            grid.innerHTML = ""; 
            
            if(courseObj.chars.length === 0) { 
                grid.innerHTML = "<div style='color:#999;width:300%;text-align:center;padding-top:50px;'>ğŸ¼ æ½˜å“’å“’è€å¸ˆæ­£åœ¨å¤‡è¯¾ä¸­...</div>"; 
            } else { 
                courseObj.chars.forEach(function(item, charIdx) { 
                    const div = document.createElement('div'); 
                    div.className = 'char-card'; 
                    div.onclick = function() { startApp(charIdx); }; 
                    div.innerHTML = "<div class='mi-grid'></div><div class='char-card-pinyin'>" + item.pinyin + "</div><div class='char-card-text'>" + item.char + "</div>"; 
                    grid.appendChild(div); 
                }); 
            } 
            navigateTo('level-screen'); 
        }
        
        function startApp(charIdx) { 
            currentActiveChar = currentActiveCourse.chars[charIdx]; 
            document.querySelectorAll('#study-char, #ghost-char, #adjust-char-overlay').forEach(function(el) { el.innerText = currentActiveChar.char; }); 

            var v = document.getElementById('study-video');
            v.src = currentActiveChar.video; 
            v.pause(); 
            v.currentTime = 0;
            document.getElementById('lesson-rule-hint').innerText = currentActiveCourse.rule_desc; 
            
            var tipText = "â€œæˆ‘èƒ½è‡ªå·±ç»ƒâ€";
            if (currentActiveCourse.grade >= 2) {
                tipText = "â€œæˆ‘èƒ½è‡ªå·±è¯„â€";
            }
            var tipEl = document.getElementById('tip-practice-place');
            if(tipEl) tipEl.innerText = tipText;

            switchPracticeStep('step-1'); 
            navigateTo('practice-screen'); 
        }

        function navigateTo(pageId) {
            var v = document.getElementById('study-video');
            if(v) v.pause();
            document.querySelectorAll('.app-screen').forEach(function(el){ el.style.display = 'none'; });
            document.getElementById(pageId).style.display = 'flex';
        }

        function switchPracticeStep(stepId) {
            var v = document.getElementById('study-video');
            if(v) v.pause();
            var paw = document.getElementById('teaching-paw');
            if(paw) paw.style.display = 'none';
            document.querySelectorAll('.step-section').forEach(function(el){ el.classList.remove('active'); });
            document.getElementById(stepId).classList.add('active');
        }

        function startPractice() {
            switchPracticeStep('step-2');
            var v = document.getElementById('study-video');
            if(v) { 
                v.currentTime = 0; 
                v.play().catch(function(e){ console.log("æ’­æ”¾å¤±è´¥"); }); 
                var paw = document.getElementById('teaching-paw');
                if(paw) paw.style.display = 'block';
            }
            startTime = Date.now();
            var charDisplay = document.getElementById('study-char');
            charDisplay.classList.remove('breathe');
            void charDisplay.offsetWidth; 
            charDisplay.classList.add('breathe');
        }

        function goToScan() {
            switchPracticeStep('step-scan');
            startCam('video-back', 'environment');
        }

        function backToPractice() {
            if (streamObj) streamObj.getTracks().forEach(t => t.stop());
            switchPracticeStep('step-2');
        }

        async function startCam(id, mode) {
            if (streamObj) streamObj.getTracks().forEach(function(t) { t.stop(); });
            try {
                var stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: mode, width: { ideal: 1280 }, height: { ideal: 720 } }, 
                    audio: false 
                });
                streamObj = stream;
                document.getElementById(id).srcObject = stream;
            } catch (e) { console.log("Cam error:", e); }
        }

        function capture() { try { var vid = document.getElementById('video-back'); var cvs = document.getElementById('cvs'); var ctx = cvs.getContext('2d'); cvs.width = 600; cvs.height = 600; var sx = (vid.videoWidth - vid.videoHeight)/2; ctx.drawImage(vid, sx, 0, vid.videoHeight, vid.videoHeight, 0, 0, 600, 600); var url = cvs.toDataURL('image/jpeg'); document.getElementById('adjust-img').src = url; document.getElementById('final-img').src = url; if (streamObj) streamObj.getTracks().forEach(function(t) { t.stop(); }); switchPracticeStep('step-adjust'); } catch(e) { alert("è¯·åˆ·æ–°é‡è¯•"); } }
        
        var posX=0, posY=0, startX=0, startY=0, lastX=0, lastY=0;
        var touchArea = document.getElementById('step-adjust');
        if(touchArea){
            touchArea.addEventListener('touchstart', function(e) { if(e.target.tagName==='INPUT')return; startX=e.touches[0].clientX; startY=e.touches[0].clientY; lastX=posX; lastY=posY; });
            touchArea.addEventListener('touchmove', function(e) { if(e.target.tagName==='INPUT')return; e.preventDefault(); posX=lastX+(e.touches[0].clientX-startX); posY=lastY+(e.touches[0].clientY-startY); updateAdjust(); });
        }
        function updateAdjust() { var sImg = document.getElementById('scale-img').value; var sTxt = document.getElementById('scale-text').value; document.getElementById('adjust-img').style.transform = 'translate(calc(-50% + '+posX+'px), calc(-50% + '+posY+'px)) scale('+sImg+')'; document.querySelector('.adjust-text').style.transform = 'scale('+sTxt+')'; }

        function checkPixelQuality() {
            try {
                var cvs = document.getElementById('analysis-cvs');
                var ctx = cvs.getContext('2d');
                var rawCvs = document.getElementById('cvs');
                ctx.drawImage(rawCvs, 0, 0, 100, 100); 
                var imgData = ctx.getImageData(0,0,100,100).data;
                var totalBright = 0;
                for(var i=0; i<imgData.length; i+=4) { totalBright += (imgData[i] + imgData[i+1] + imgData[i+2])/3; }
                var avgBright = totalBright / (100*100);
                if(avgBright < 30) return "too_dark";
                if(avgBright > 240) return "too_bright";
                return "ok";
            } catch(e) { return "ok"; }
        }

        function checkQualityAndConfirm() {
            var quality = checkPixelQuality();
            if(quality === "too_dark") { alert("ğŸ¼ æ½˜å“’å“’æç¤ºï¼š\nå…‰çº¿å¤ªæš—å•¦ï¼Œçœ‹ä¸æ¸…å­—å“¦ï¼\nè¯·å¼€ç¯åå†æ‹ä¸€æ¬¡å§~"); return; }
            if(quality === "too_bright") { alert("ğŸ¼ æ½˜å“’å“’æç¤ºï¼š\nå¤ªäº®å•¦ï¼Œçº¸å¼ åå…‰çœ‹ä¸æ¸…å­—ï¼\næ¢ä¸ªè§’åº¦æ‹æ‹çœ‹~"); return; }
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('confirm-modal').style.display = 'none'; }

        function confirmAndReport() {
            closeModal();
            document.getElementById('ai-loading').style.display = 'flex';
            // ç»Ÿä¸€ä»å¤–éƒ¨è¯„è¯­åº“æ–‡ä»¶ä¸­ç”Ÿæˆæ™ºèƒ½è¯„è¯­
            if (typeof window.generateSmartComment === 'function') {
                window.generateSmartComment({
                    startTime,
                    currentActiveChar,
                    currentActiveCourse,
                    targetElementId: 'ai-comment'
                });
            } else {
                document.getElementById('ai-comment').innerHTML = "ç½‘ç»œå¼€å°å·®äº†ï¼Œæ²¡åŠ è½½åˆ°è¯„è¯­åº“... ğŸ¼";
            }
            setTimeout(function() {
                document.getElementById('ai-loading').style.display = 'none';
                finishAdjustReal();
            }, 1500);
        }

        function finishAdjustReal() {
            var finalImg = document.getElementById('final-img');
            finalImg.src = document.getElementById('adjust-img').src;
            finalImg.style.transform = document.getElementById('adjust-img').style.transform;
            var v = document.getElementById('study-video');
            if(v) v.pause();
            var stamp = document.querySelector('.stamp');
            stamp.classList.remove('show');
            void stamp.offsetWidth; 
            stamp.classList.add('show');
            switchPracticeStep('step-report');
        }
    </script>
</body>
</html>
