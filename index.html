<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ½˜å“’å“’ä¹¦æ³•è¯¾ - å®Œç»“ç¯‡</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background-color: #F5F1E8; font-family: "PingFang SC", "Microsoft YaHei", sans-serif; height: 100vh; overflow: hidden; color: #3E2723; }
        .app-screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: none; flex-direction: column !important; }
        .panda-icon { width: 60px; height: 60px; object-fit: contain; }
        .panda-lg { width: 140px; height: 140px; object-fit: contain; }
        @keyframes breathe { 0% { transform: scale(1); color: #333; } 50% { transform: scale(1.08); color: #d35400; } 100% { transform: scale(1); color: #333; } }
        .breathe { animation: breathe 3s infinite ease-in-out; position: relative; z-index: 10; }
        @keyframes paw-move { 0%, 100% { transform: translateY(0) rotate(10deg); } 50% { transform: translateY(-10px) rotate(5deg); } }
        #teaching-paw { display: none; position: absolute; bottom: -20px; right: -20px; width: 60px; z-index: 20; pointer-events: none; animation: paw-move 1.5s infinite ease-in-out; }
        @keyframes breathe-panda { 0% { transform: scale(0.95); opacity: 0.9; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(0.95); opacity: 0.9; } }
        .thinking-anim { animation: breathe-panda 1.5s infinite ease-in-out; }
        .cheer-panda { position: absolute; right: -5px; top: -55px; width: 90px; transform: rotate(10deg); z-index: 5; pointer-events: none; }
        .posture-text-top { position: absolute; top: 13%; left: 0; width: 100%; text-align: center; color: #FFD700; font-size: 20px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.8); z-index: 60; letter-spacing: 1px; }
        .posture-guide { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); width: 260px; height: 350px; border: 4px dashed #FF9800; border-radius: 150px 150px 0 0; box-shadow: 0 0 0 1000px rgba(0,0,0,0.6); z-index: 50; }
        .posture-tips-box { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); width: 85%; background: rgba(255, 255, 255, 0.95); border-radius: 12px; padding: 15px; border: 2px solid #FFCC80; z-index: 60; font-size: 15px; color: #5D4037; font-weight: bold; line-height: 1.6; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .posture-panda-icon { position: absolute; top: -45px; left: -10px; width: 70px; transform: rotate(-10deg); }
        .study-container { width: 100%; flex: 1; display: flex; flex-direction: column; align-items: center; background: #FFF8E1; padding-top: 60px; overflow-y: auto; padding-bottom: 120px; }
        .lesson-panda { position: absolute; top: -45px; right: 10px; width: 70px; transform: rotate(10deg); }
        .prep-tips { width: 90%; margin-top: 25px; background: rgba(255, 255, 255, 0.6); border-radius: 10px; padding: 12px; font-size: 13px; color: #5D4037; line-height: 1.6; border: 1px solid #EFEBE9; position: relative; }
        .hint-card { background: #FFF3E0; padding: 12px 20px; border-radius: 12px; margin-top: 10px; color: #E65100; font-size: 15px; text-align: center; width: 90%; border: 1px dashed #FFB74D; display: flex; flex-direction: column; justify-content: center; }
        .scan-hint-box { position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 30px; z-index: 60; width: 80%; overflow: visible; }
        .scan-hint-text { color: white; font-size: 15px; font-weight: bold; text-align: center; width: 100%; }
        .scan-panda-icon { position: absolute; right: -10px; top: -35px; width: 60px; transform: rotate(15deg); }
        .scan-overlay-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 150px; height: 150px; border: 3px solid #FFD700; box-shadow: 0 0 0 1000px rgba(0,0,0,0.7); z-index: 50; display: flex; justify-content: center; align-items: center; }
        #ghost-char { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; opacity: 0.6; color: red; font-size: 85px; font-family: 'KaiTi'; }
        .adjust-box { width: 200px; height: 200px; border: 2px solid #FFD700; overflow: hidden; background: #fff; margin-bottom: 20px; position: relative; }
        #adjust-img { position: absolute; top: 50%; left: 50%; width: 100%; height: 100%; object-fit: cover; transform: translate(-50%, -50%); opacity: 0.7; }
        .adjust-overlay { position: absolute; width: 100%; height: 100%; pointer-events: none; display: flex; justify-content: center; align-items: center; top: 0; left: 0; }
        .adjust-text { font-family: 'KaiTi'; font-size: 120px; color: #e74c3c; opacity: 0.6; transform-origin: center center; }
        .controls { width: 90%; color: white; display: flex; flex-direction: column; gap: 15px; position: relative; }
        .range-wrap { display: flex; align-items: center; justify-content: space-between; font-size: 16px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 15px; }
        input[type=range] { -webkit-appearance: none; width: 65%; height: 8px; background: rgba(255,255,255,0.3); border-radius: 5px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 35px; height: 35px; border-radius: 50%; background: #FF9500; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.4); border: 3px solid white; }
        .controls-hint-box { display: flex; justify-content: center; align-items: center; margin-top: 15px; gap: 5px; }
        .controls-hint-text { font-size:18px; font-weight:800; color:#FFD700; text-shadow: 0 2px 4px rgba(0,0,0,0.9); letter-spacing: 1px; }
        .controls-panda-icon { width: 45px; height: auto; transform: rotate(-10deg); }
        #home-screen { padding: 20px; overflow-y: auto; }
        .home-header { margin-bottom: 20px; text-align: center; }
        .app-title { font-size: 28px; color: #E65100; font-weight: 800; letter-spacing: 2px; }
        .app-subtitle { font-size: 14px; color: #8D6E63; margin-top: 5px; }
        .course-list { display: flex; flex-direction: column; gap: 15px; padding-bottom: 40px; }
        .course-card { background: #fff; border-radius: 16px; padding: 15px 20px; box-shadow: 0 4px 12px rgba(230, 81, 0, 0.08); border-left: 6px solid #FF9800; cursor: pointer; transition: transform 0.1s; display: flex; justify-content: space-between; align-items: center; }
        .course-idx { font-size: 32px; font-weight: bold; color: #FFE0B2; margin-right: 15px; font-family: 'Arial'; }
        .course-info { flex: 1; }
        .course-title { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px; }
        .course-desc { font-size: 12px; color: #999; line-height: 1.4; } 
        .course-arrow { color: #FFCC80; font-size: 20px; }
        .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px; overflow-y: auto; flex: 1; }
        .char-card { background: #fff; aspect-ratio: 1; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid #FFE0B2; position: relative; cursor: pointer; }
        .char-card-text { font-family: 'KaiTi'; font-size: 42px; color: #333; }
        .char-card-pinyin { font-size: 12px; color: #888; margin-bottom: -5px; }
        .mi-grid { position: absolute; width: 80%; height: 80%; border: 1px dashed #FFCC80; pointer-events: none; }
        .mi-grid::before { content:''; position:absolute; top:50%; width:100%; height:1px; background:#FFCC80; }
        .mi-grid::after { content:''; position:absolute; left:50%; height:100%; width:1px; background:#FFCC80; }
        .nav-bar { display: flex; align-items: center; padding: 15px; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10; width: 100%; flex-shrink: 0; }
        .nav-back { font-size: 24px; padding: 0 15px 0 5px; color: #555; cursor: pointer; }
        .nav-title { font-size: 18px; font-weight: bold; flex: 1; text-align: center; padding-right: 40px; }
        .btn-main { position: absolute; bottom: 30px; background: linear-gradient(to right, #FF9500, #FF5E3A); color: white; padding: 12px 40px; border-radius: 50px; border: none; font-size: 18px; font-weight: bold; box-shadow: 0 5px 15px rgba(255, 94, 58, 0.4); z-index: 50; cursor: pointer; }
        .final-frame { width: 200px; height: 200px; border: 8px solid #FFB74D; border-radius: 4px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); overflow: hidden; position: relative; margin: 20px 0; background: #fff; }
        #final-img { position: absolute; top: 50%; left: 50%; width: 100%; height: 100%; object-fit: cover; transform: translate(-50%, -50%); }
        .comment-bubble { background: #fff; padding: 20px; border-radius: 15px; border: 2px solid #FFCC80; width: 90%; position: relative; margin-top: 10px; }
        .comment-bubble::before { content:''; position:absolute; top:-10px; left:50%; transform:translateX(-50%); border-width:0 10px 10px 10px; border-style:solid; border-color:transparent transparent #FFCC80 transparent; }
        .stamp { position: absolute; bottom: 20px; right: 20px; width: 100px; height: 100px; border: 3px solid #D32F2F; border-radius: 50%; color: #D32F2F; font-size: 18px; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; transform: rotate(-20deg); opacity: 0; background: rgba(255, 255, 255, 0.8); box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.2); }
        .stamp.show { animation: stampIn 0.5s ease-out forwards; }
        #ai-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 248, 225, 0.95); z-index: 999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #confirm-modal { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal-box { background: white; width: 80%; border-radius: 20px; padding: 20px; text-align: center; }
        .modal-btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .btn-cancel { flex:1; padding: 10px; background: #ddd; border-radius: 25px; border:none; font-weight: bold; }
        .btn-ok { flex:1; padding: 10px; background: #FF9800; color: white; border-radius: 25px; border:none; font-weight: bold; }
        .step-section { display: none; width: 100%; height: 100%; flex-direction: column !important; align-items: center; position: absolute; top:0; left:0; }
        .step-section.active { display: flex !important; }
        #step-1, #step-scan, #step-adjust { justify-content: center; }
        #step-2, #step-report { justify-content: flex-start; }
    </style>
</head>
<body>
    <div id="ai-loading"><img src="images/panda_thinking.png" class="panda-lg thinking-anim"><div class="loading-text" style="margin-top:20px; color:#E65100; font-weight:bold; font-size:18px;">æ½˜å“’å“’æ­£åœ¨æƒ³è¯„è¯­...</div><div style="font-size:12px; color:#999; margin-top:10px;">çœ‹çœ‹ä½ çš„ç¬”é”‹æœ‰æ²¡æœ‰åˆ°ä½~</div></div>
    <div id="confirm-modal"><div class="modal-box"><h3 style="color:#E65100; margin-top:0;">ğŸ¼ æ½˜å“’å“’é—®ä½ </h3><p style="color:#666; font-size:14px;">å­—åœ¨æ¡†æ¡†æ­£ä¸­é—´å—ï¼Ÿ<br>èƒ½ä¸èƒ½çœ‹æ¸…æ¥šï¼Ÿ</p><div class="modal-btn-row"><button class="btn-cancel" onclick="closeModal()">ä¸æ¸…æ¥šï¼Œé‡æ‹</button><button class="btn-ok" onclick="confirmAndReport()">çœ‹æ¸…äº†ï¼Œæäº¤ï¼</button></div></div></div>
    <div id="home-screen" class="app-screen" style="display: flex;"><div class="home-header"><div style="display:flex; justify-content:center; align-items:center; gap:5px;"><div class="app-title">æ½˜å“’å“’ä¹¦æ³•è¯¾</div><img src="images/panda_welcome.png" class="panda-icon"></div><div class="app-subtitle">ä¸€å¹´çº§ä¸‹å†Œ Â· è§„èŒƒä¹¦å†™</div></div><div class="course-list" id="course-list"></div></div>
    <div id="level-screen" class="app-screen"><div class="nav-bar"><div class="nav-back" onclick="navigateTo('home-screen')">â®</div><div class="nav-title" id="level-title">è¯¾ç¨‹è¯¦æƒ…</div></div><div class="char-grid" id="char-list"></div></div>
    <div id="practice-screen" class="app-screen">
        <div id="step-1" class="step-section active"><div class="nav-bar" style="position:absolute;top:0;background:transparent;box-shadow:none;"><div class="nav-back" style="color:white;background:rgba(0,0,0,0.3);border-radius:50%;width:30px;height:30px;text-align:center;padding:0;" onclick="navigateTo('level-screen')">âœ•</div></div><div class="camera-box"><video id="video-front" class="mirror" autoplay playsinline muted></video><div class="posture-text-top">è¯·å°†å¤´æ­£å¯¹è™šæ¡†å†…</div><div class="posture-guide"></div><div class="posture-tips-box"><img src="images/panda_posture.png" class="posture-panda-icon"><div style="font-weight:bold; color:#E65100; margin-bottom:5px;">ğŸ“ æ½˜å“’å“’å¥½ä¹ æƒ¯ï¼š</div><div>æ‰‹ç¦»ç¬”å°–ä¸€æŒ‡èŠ‚<br>çœ¼ç¦»çº¸æœ¬ä¸€å°è‡‚<br>èƒ¸ç¦»æ¡Œè¾¹ä¸€å°æ‹³</div></div></div><button class="btn-main" onclick="startPractice()">âœ… åå¥½äº†</button></div>
        <div id="step-2" class="step-section" style="background:#FFF8E1;"><div class="nav-bar"><div class="nav-back" onclick="navigateTo('level-screen')">â®</div><div class="nav-title">è·Ÿç€æ½˜å“’å“’å†™</div></div><div class="study-container"><div class="video-box"><video id="study-video" src="" controls loop playsinline preload="none"></video><img id="teaching-paw" src="images/panda_welcome.png"></div><div class="tian-zi-ge"><div class="line-h"></div><div class="line-v"></div><div class="char-display breathe" id="study-char">?</div></div><div class="hint-card"><div style="font-weight:bold; margin-bottom:5px;">ğŸ’¡ æœ¬è¯¾é‡ç‚¹ï¼š</div><span id="lesson-rule-hint" style="color:#5D4037;">...</span></div><div class="prep-tips"><img src="images/panda_lesson.png" class="lesson-panda"><div style="font-weight:bold; margin-bottom:5px; color:#E65100;">ğŸ“ ç»ƒä¹ å°è´´å£«ï¼š</div><div style="margin-bottom:4px;">1. è¯·åœ¨ä¹¦ä¸Š<b>â€œæˆ‘èƒ½è‡ªå·±ç»ƒâ€</b>çš„ç”°å­—æ ¼é‡Œç»ƒä¹ ï¼Œæ–¹ä¾¿åç»­è¯„ä»·ã€‚</div><div style="margin-bottom:4px;">2. ç»ƒä¹ ä¹‹å‰å…ˆæ£€æŸ¥è‡ªå·±çš„<b>åŒæ‰‹æ˜¯å¦å¹²å‡€</b>ï¼Œ<b>æ¡Œé¢æ˜¯å¦æ•´æ´</b>ï¼Œç„¶åå†å†™å­—ã€‚</div><div>3. ä¿æŒæ­£ç¡®<b>æ¡ç¬”å§¿åŠ¿</b>ï¼šå†™å­—æ—¶æ‰§ç¬”å§¿åŠ¿è¦æ­£ç¡®ï¼Œ<b>å¤§æ‹‡æŒ‡ä¸èƒ½å‹é£ŸæŒ‡</b>ã€‚</div></div><button class="btn-main" onclick="goToScan()">ğŸ“¸ ç»ƒå¥½äº†ï¼Œå»æ‹ç…§</button></div></div>
        <div id="step-scan" class="step-section"><div class="nav-bar" style="position:absolute;top:0;width:100%;background:transparent;box-shadow:none;z-index:70;"><div class="nav-back" style="color:white;background:rgba(0,0,0,0.3);border-radius:50%;width:30px;height:30px;text-align:center;padding:0;line-height:30px;" onclick="backToPractice()">â®</div></div><div class="camera-box"><video id="video-back" autoplay playsinline muted></video><div class="scan-overlay-box"><div style="width:150px;height:150px;display:flex;justify-content:center;align-items:center;opacity:0.6;color:red;font-size:85px;font-family:'KaiTi';" id="ghost-char">?</div></div><div class="scan-hint-box"><div class="scan-hint-text">å¯¹å‡†ç”°å­—æ ¼é‡Œçš„å­—ï¼Œå’”åš“ä¸€ä¸‹ï¼</div><img src="images/panda_welcome.png" class="scan-panda-icon"></div></div><button class="btn-main" onclick="capture()">ğŸ“¸ å’”åš“</button></div>
        <div id="step-adjust" class="step-section" style="background:#222;"><div class="adjust-box"><img id="adjust-img" src=""><div class="adjust-overlay"><div class="adjust-text" id="adjust-char-overlay">?</div></div></div><div class="controls"><div class="controls-hint-box"><img src="images/panda_posture.png" class="controls-panda-icon"><div class="controls-hint-text">æ‹–åŠ¨æ»‘æ†ï¼ŒæŠŠçº¢å­—å’Œä½ çš„å­—å¯¹é½</div></div><div class="range-wrap"><span>ğŸ–¼ï¸ å›¾ç‰‡</span><input type="range" min="0.5" max="2.5" step="0.05" value="1" id="scale-img" oninput="updateAdjust()"></div><div class="range-wrap"><span>ğŸ”  çº¢å­—</span><input type="range" min="0.5" max="1.5" step="0.05" value="1" id="scale-text" oninput="updateAdjust()"></div></div><button class="btn-main" onclick="checkQualityAndConfirm()" style="bottom:50px;">âœ¨ æäº¤ä½œå“</button></div>
        <div id="step-report" class="step-section" style="background:#FFF8E1;overflow-y:auto;justify-content:flex-start;"><div class="nav-bar"><div class="nav-back" onclick="navigateTo('level-screen')">â®</div><div class="nav-title">å°å°ä¹¦æ³•å®¶</div></div><div class="final-frame"><img id="final-img" src=""></div><div class="stamp"><img src="images/panda_avatar.png" style="width:50px; opacity:0.9; margin-bottom:5px;"><div style="font-size:14px; color:#D32F2F; margin-top:-5px;">ä¼˜ç§€</div></div><div class="comment-bubble"><img src="images/panda_success.png" class="cheer-panda"><div style="text-align:center;font-size:24px;color:#FFD700;margin-bottom:5px;">â˜…â˜…â˜…â˜…â˜†</div><div style="font-size:14px;color:#555;line-height:1.6;" id="ai-comment">...</div></div><button class="btn-main" style="position:static;margin-top:20px;margin-bottom:40px;" onclick="navigateTo('level-screen')">ğŸ å®Œæˆï¼Œç»ƒä¸‹ä¸€ä¸ª</button></div>
    </div>

    <canvas id="cvs" style="display:none;"></canvas>
    <canvas id="analysis-cvs" style="display:none;" width="100" height="100"></canvas>

    <script src="js/comments.js"></script>

    <script>
        window.onerror = function(msg, url, line) { return false; };

        var streamObj = null;
        var currentActiveChar = null;
        var currentLessonId = null;
        var startTime = 0; 

        const COURSE_DATA = [
            { id: 1, title: "åŸºæœ¬ç¬”ç”»ç»ƒä¹ ", rule_desc: "çŸ­æ¨ªã€çŸ­ç«–", chars: [ { char: "æ˜¥", pinyin: "chÅ«n", video: "videos/æ˜¥.mp4" }, { char: "é’", pinyin: "qÄ«ng", video: "videos/é’.mp4" }, { char: "å½“", pinyin: "dÄng", video: "videos/å½“.mp4" }, { char: "å…±", pinyin: "gÃ²ng", video: "videos/å…±.mp4" }, { char: "å…ƒ", pinyin: "yuÃ¡n", video: "videos/å…ƒ.mp4" }, { char: "æ­¢", pinyin: "zhÇ", video: "videos/æ­¢.mp4" }, { char: "ä»–", pinyin: "tÄ", video: "videos/ä»–.mp4" } ] },
            { id: 2, title: "ç¬”é¡ºè§„åˆ™æŒæ¡", rule_desc: "å…ˆå¤–åå†…å†å°å£", chars: [ { char: "å›", pinyin: "huÃ­", video: "videos/å›.mp4" }, { char: "æ—¥", pinyin: "rÃ¬", video: "videos/æ—¥.mp4" }, { char: "ç›®", pinyin: "mÃ¹", video: "videos/ç›®.mp4" }, { char: "è‡ª", pinyin: "zÃ¬", video: "videos/è‡ª.mp4" }, { char: "ç”°", pinyin: "tiÃ¡n", video: "videos/ç”°.mp4" }, { char: "å››", pinyin: "sÃ¬", video: "videos/å››.mp4" }, { char: "ç™½", pinyin: "bÃ¡i", video: "videos/ç™½.mp4" } ] },
            { id: 3, title: "åŸºæœ¬ç¬”ç”»ç»ƒä¹ ", rule_desc: "æ¨ªæŠ˜å¼¯ã€æ¨ªæŠ˜æŠ˜æ’‡ã€æ¨ªæ’‡å¼¯é’©", chars: [ { char: "æ²¡", pinyin: "mÃ©i", video: "videos/æ²¡.mp4" }, { char: "é€ ", pinyin: "zÃ o", video: "videos/é€ .mp4" }, { char: "è¿œ", pinyin: "yuÇn", video: "videos/è¿œ.mp4" }, { char: "é˜Ÿ", pinyin: "duÃ¬", video: "videos/é˜Ÿ.mp4" }, { char: "æœµ", pinyin: "duÇ’", video: "videos/æœµ.mp4" }, { char: "è¿", pinyin: "yÃ¹n", video: "videos/è¿.mp4" } ] },
            { id: 4, title: "åŸºæœ¬ç¬”ç”»ç»ƒä¹ ", rule_desc: "æ¨ªæ–œé’©ã€æ¨ªæŠ˜æ", chars: [ { char: "é£", pinyin: "fÄ“i", video: "videos/é£.mp4" }, { char: "è¯·", pinyin: "qÇng", video: "videos/è¯·.mp4" }, { char: "è¯", pinyin: "zhÃ¨ng", video: "videos/è¯.mp4" }, { char: "è¯†", pinyin: "shÃ­", video: "videos/è¯†.mp4" }, { char: "æ°”", pinyin: "qÃ¬", video: "videos/æ°”.mp4" }, { char: "è®¤", pinyin: "rÃ¨n", video: "videos/è®¤.mp4" }, { char: "è®©", pinyin: "rÃ ng", video: "videos/è®©.mp4" } ] },
            { id: 5, title: "åŸºæœ¬ç¬”ç”»ç»ƒä¹ ", rule_desc: "å·¦ç‚¹ã€å³ç‚¹", chars: [ { char: "å°–", pinyin: "jiÄn", video: "videos/å°–.mp4" }, { char: "ç±³", pinyin: "mÇ", video: "videos/ç±³.mp4" }, { char: "å¹¿", pinyin: "guÇng", video: "videos/å¹¿.mp4" }, { char: "ä¸º", pinyin: "wÃ¨i", video: "videos/ä¸º.mp4" }, { char: "å¤–", pinyin: "wÃ i", video: "videos/å¤–.mp4" }, { char: "å…´", pinyin: "xÃ¬ng", video: "videos/å…´.mp4" }, { char: "å¹³", pinyin: "pÃ­ng", video: "videos/å¹³.mp4" } ] },
            { id: 6, title: "éƒ¨ä»¶ç»„åˆä¸ç¬”é¡º", rule_desc: "ç‚¹çš„ä½ç½®ä¸å½¢æ€", chars: [ { char: "æ²™", pinyin: "shÄ", video: "videos/æ²™.mp4" }, { char: "è®©", pinyin: "rÃ ng", video: "videos/è®©.mp4" }, { char: "å¹¿", pinyin: "guÇng", video: "videos/å¹¿.mp4" }, { char: "æ–¹", pinyin: "fÄng", video: "videos/æ–¹.mp4" } ] },
            { id: 7, title: "åŸºæœ¬ç¬”ç”»ç»ƒä¹ ", rule_desc: "å¹³æ’‡ã€æ–œæ’‡", chars: [ { char: "è®¤", pinyin: "rÃ¨n", video: "videos/è®¤.mp4" }, { char: "ä»", pinyin: "cÃ³ng", video: "videos/ä».mp4" }, { char: "åƒ", pinyin: "qiÄn", video: "videos/åƒ.mp4" }, { char: "ç¦¾", pinyin: "hÃ©", video: "videos/ç¦¾.mp4" } ] },
            { id: 8, title: "åŸºæœ¬ç¬”ç”»ç»ƒä¹ ", rule_desc: "ç«–æ’‡", chars: [ { char: "èƒ¡", pinyin: "hÃº", video: "videos/èƒ¡.mp4" }, { char: "è®²", pinyin: "jiÇng", video: "videos/è®².mp4" }, { char: "å¼€", pinyin: "kÄi", video: "videos/å¼€.mp4" }, { char: "ç”¨", pinyin: "yÃ²ng", video: "videos/ç”¨.mp4" }, { char: "æœˆ", pinyin: "yuÃ¨", video: "videos/æœˆ.mp4" }, { char: "çš®", pinyin: "pÃ­", video: "videos/çš®.mp4" }, { char: "äº•", pinyin: "jÇng", video: "videos/äº•.mp4" } ] },
            { id: 9, title: "åŸºæœ¬ç¬”ç”»ç»ƒä¹ ", rule_desc: "å¹³æº", chars: [ { char: "ä¹‹", pinyin: "zhÄ«", video: "videos/ä¹‹.mp4" }, { char: "é€ ", pinyin: "zÃ o", video: "videos/é€ .mp4" }, { char: "è¿œ", pinyin: "yuÇn", video: "videos/è¿œ.mp4" }, { char: "è¿‘", pinyin: "jÃ¬n", video: "videos/è¿‘.mp4" }, { char: "è¿˜", pinyin: "hÃ¡i", video: "videos/è¿˜.mp4" }, { char: "è¿‡", pinyin: "guÃ²", video: "videos/è¿‡.mp4" } ] },
            { 
                id: 10, 
                title: "ç¬”é¡ºè§„åˆ™æŒæ¡", 
                rule_desc: "å·¦ä¸ŠåŒ…å›´å’Œå³ä¸ŠåŒ…å›´", 
                chars: [
                    { char: "å·¦", pinyin: "zuÇ’", video: "videos/å·¦.mp4" },
                    { char: "å³", pinyin: "yÃ²u", video: "videos/å³.mp4" },
                    { char: "çŸ³", pinyin: "shÃ­", video: "videos/çŸ³.mp4" },
                    { char: "æœ‰", pinyin: "yÇ’u", video: "videos/æœ‰.mp4" },
                    { char: "åŒ…", pinyin: "bÄo", video: "videos/åŒ….mp4" },
                    { char: "é¥±", pinyin: "bÇo", video: "videos/é¥±.mp4" },
                    { char: "æŠ±", pinyin: "bÃ o", video: "videos/æŠ±.mp4" }
                ] 
            }
        ];

        window.onload = function() { renderHome(); startCam('video-front', 'user'); };

        function renderHome() { 
            const list = document.getElementById('course-list'); 
            if (!list) return;
            list.innerHTML = ""; 
            COURSE_DATA.forEach(function(course, idx) { 
                const div = document.createElement('div'); 
                div.className = 'course-card'; 
                div.onclick = function() { openLevel(idx); }; 
                div.innerHTML = "<div style='display:flex;align-items:center;'><div class='course-idx'>" + course.id + "</div><div class='course-info'><div class='course-title'>" + course.title + "</div><div class='course-desc'>ğŸ¯ " + course.rule_desc + "</div></div></div><div class='course-arrow'>âœ</div>"; 
                list.appendChild(div); 
            }); 
        }

        function openLevel(idx) { const course = COURSE_DATA[idx]; currentLessonId = idx; document.getElementById('level-title').innerText = course.title; const grid = document.getElementById('char-list'); grid.innerHTML = ""; if(course.chars.length === 0) { grid.innerHTML = "<div style='color:#999;width:300%;text-align:center;'>æœ¬è¯¾å†…å®¹å³å°†ä¸Šçº¿...</div>"; } else { course.chars.forEach(function(item, charIdx) { const div = document.createElement('div'); div.className = 'char-card'; div.onclick = function() { startApp(charIdx); }; div.innerHTML = "<div class='mi-grid'></div><div class='char-card-pinyin'>" + item.pinyin + "</div><div class='char-card-text'>" + item.char + "</div>"; grid.appendChild(div); }); } navigateTo('level-screen'); }
        
        function startApp(charIdx) { 
            currentActiveChar = COURSE_DATA[currentLessonId].chars[charIdx]; 
            document.querySelectorAll('#study-char, #ghost-char, #adjust-char-overlay').forEach(function(el) { el.innerText = currentActiveChar.char; }); 
            var v = document.getElementById('study-video');
            v.src = currentActiveChar.video; 
            v.pause(); 
            v.currentTime = 0;
            document.getElementById('lesson-rule-hint').innerText = COURSE_DATA[currentLessonId].rule_desc; 
            switchPracticeStep('step-1'); 
            navigateTo('practice-screen'); 
        }

        function navigateTo(pageId) {
            var v = document.getElementById('study-video');
            if(v) v.pause();
            document.querySelectorAll('.app-screen').forEach(function(el){ el.style.display = 'none'; });
            document.getElementById(pageId).style.display = 'flex';
        }

        function switchPracticeStep(stepId) {
            var v = document.getElementById('study-video');
            if(v) v.pause();
            var paw = document.getElementById('teaching-paw');
            if(paw) paw.style.display = 'none';
            document.querySelectorAll('.step-section').forEach(function(el){ el.classList.remove('active'); });
            document.getElementById(stepId).classList.add('active');
        }

        function startPractice() {
            switchPracticeStep('step-2');
            var v = document.getElementById('study-video');
            if(v) { 
                v.currentTime = 0; 
                v.play().catch(function(e){ console.log("æ’­æ”¾å¤±è´¥"); }); 
                var paw = document.getElementById('teaching-paw');
                if(paw) paw.style.display = 'block';
            }
            startTime = Date.now();
            var charDisplay = document.getElementById('study-char');
            charDisplay.classList.remove('breathe');
            void charDisplay.offsetWidth; 
            charDisplay.classList.add('breathe');
        }

        function goToScan() {
            switchPracticeStep('step-scan');
            startCam('video-back', 'environment');
        }

        function backToPractice() {
            if (streamObj) streamObj.getTracks().forEach(t => t.stop());
            switchPracticeStep('step-2');
        }

        async function startCam(id, mode) {
            if (streamObj) streamObj.getTracks().forEach(function(t) { t.stop(); });
            try {
                var stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: mode, width: { ideal: 1280 }, height: { ideal: 720 } }, 
                    audio: false 
                });
                streamObj = stream;
                document.getElementById(id).srcObject = stream;
            } catch (e) { console.log("Cam error:", e); }
        }

        function capture() { try { var vid = document.getElementById('video-back'); var cvs = document.getElementById('cvs'); var ctx = cvs.getContext('2d'); cvs.width = 600; cvs.height = 600; var sx = (vid.videoWidth - vid.videoHeight)/2; ctx.drawImage(vid, sx, 0, vid.videoHeight, vid.videoHeight, 0, 0, 600, 600); var url = cvs.toDataURL('image/jpeg'); document.getElementById('adjust-img').src = url; document.getElementById('final-img').src = url; if (streamObj) streamObj.getTracks().forEach(function(t) { t.stop(); }); switchPracticeStep('step-adjust'); } catch(e) { alert("è¯·åˆ·æ–°é‡è¯•"); } }
        
        var posX=0, posY=0, startX=0, startY=0, lastX=0, lastY=0;
        var touchArea = document.getElementById('step-adjust');
        if(touchArea){
            touchArea.addEventListener('touchstart', function(e) { if(e.target.tagName==='INPUT')return; startX=e.touches[0].clientX; startY=e.touches[0].clientY; lastX=posX; lastY=posY; });
            touchArea.addEventListener('touchmove', function(e) { if(e.target.tagName==='INPUT')return; e.preventDefault(); posX=lastX+(e.touches[0].clientX-startX); posY=lastY+(e.touches[0].clientY-startY); updateAdjust(); });
        }
        function updateAdjust() { var sImg = document.getElementById('scale-img').value; var sTxt = document.getElementById('scale-text').value; document.getElementById('adjust-img').style.transform = 'translate(calc(-50% + '+posX+'px), calc(-50% + '+posY+'px)) scale('+sImg+')'; document.querySelector('.adjust-text').style.transform = 'scale('+sTxt+')'; }

        function checkPixelQuality() {
            try {
                var cvs = document.getElementById('analysis-cvs');
                var ctx = cvs.getContext('2d');
                var rawCvs = document.getElementById('cvs');
                ctx.drawImage(rawCvs, 0, 0, 100, 100); 
                var imgData = ctx.getImageData(0,0,100,100).data;
                var totalBright = 0;
                for(var i=0; i<imgData.length; i+=4) { totalBright += (imgData[i] + imgData[i+1] + imgData[i+2])/3; }
                var avgBright = totalBright / (100*100);
                if(avgBright < 30) return "too_dark";
                if(avgBright > 240) return "too_bright";
                return "ok";
            } catch(e) { return "ok"; }
        }

        function checkQualityAndConfirm() {
            var quality = checkPixelQuality();
            if(quality === "too_dark") { alert("ğŸ¼ æ½˜å“’å“’æç¤ºï¼š\nå…‰çº¿å¤ªæš—å•¦ï¼Œçœ‹ä¸æ¸…å­—å“¦ï¼\nè¯·å¼€ç¯åå†æ‹ä¸€æ¬¡å§~"); return; }
            if(quality === "too_bright") { alert("ğŸ¼ æ½˜å“’å“’æç¤ºï¼š\nå¤ªäº®å•¦ï¼Œçº¸å¼ åå…‰çœ‹ä¸æ¸…å­—ï¼\næ¢ä¸ªè§’åº¦æ‹æ‹çœ‹~"); return; }
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('confirm-modal').style.display = 'none'; }

        function confirmAndReport() {
            closeModal();
            document.getElementById('ai-loading').style.display = 'flex';
            generateSmartComment();
            setTimeout(function() {
                document.getElementById('ai-loading').style.display = 'none';
                finishAdjustReal();
            }, 1500);
        }

        function generateSmartComment() {
            var duration = (Date.now() - startTime); 
            var speedType = 'normal';
            if (duration < 8000) speedType = 'fast'; 
            if (duration > 30000) speedType = 'slow'; 

            // âš ï¸ ç¡®ä¿ COMMENT_DB å·²åŠ è½½
            if (typeof window.COMMENT_DB === 'undefined') {
                document.getElementById('ai-comment').innerHTML = "ç½‘ç»œå¼€å°å·®äº†ï¼Œæ²¡åŠ è½½åˆ°è¯„è¯­åº“... ğŸ¼";
                return;
            }
            // ç›´æ¥ä½¿ç”¨ window.COMMENT_DB (å› ä¸ºå·²ç»æŒ‚è½½åˆ°å…¨å±€)
            var DB = window.COMMENT_DB;

            var openList = DB.openings[speedType];
            var opening = openList[Math.floor(Math.random() * openList.length)];

            var charKey = currentActiveChar.char;
            var detailList = DB.details[charKey] || DB.details["default"];
            var techDetail = detailList[Math.floor(Math.random() * detailList.length)];

            var structureInfo = "";
            var currentLessonIdNum = COURSE_DATA[currentLessonId].id;

            var flatChars = ["å›", "å››", "ç”°", "ç™½", "æ˜¥", "å…±", "å…ƒ"];
            var tallChars = ["æ—¥", "ç›®", "è‡ª", "é’", "æ­¢", "ä»–", "å½“"];
            var leftSmallChars = ["æ²¡", "é˜Ÿ"];
            var semiChars = ["é€ ", "è¿œ", "è¿"];
            var obliqueHookChars = ["é£", "æ°”"];
            var speechChars = ["è¯·", "è¯", "è¯†", "è®¤", "è®©"]; 
            var symmetryChars = ["å°–", "ç±³", "å¹³"];
            var diagonalChars = ["å¹¿", "ä¸º", "å¤–", "å…´"];
            var dotRulesChars = ["æ²™", "æ–¹"]; 
            var flatPieChars = ["åƒ", "ç¦¾"];
            var slantPieChars = ["è®¤", "ä»"];
            var verticalPieChars = ["èƒ¡", "è®²", "å¼€", "ç”¨", "æœˆ", "çš®", "äº•"];
            var flatNaChars = ["ä¹‹", "é€ ", "è¿œ", "è¿‘", "è¿˜", "è¿‡"];
            var semiWrapChars = ["åŒ…", "é¥±", "æŠ±"];

            var structType = "general";

            if (currentLessonIdNum === 6 && ["è®©", "å¹¿", "æ²™", "æ–¹"].includes(charKey)) structType = "dotRules";
            else if (currentLessonIdNum === 7 && flatPieChars.includes(charKey)) structType = "flatPie";
            else if (currentLessonIdNum === 7 && slantPieChars.includes(charKey)) structType = "slantPie";
            else if (currentLessonIdNum === 8 && verticalPieChars.includes(charKey)) structType = "verticalPie";
            else if (currentLessonIdNum === 9 && flatNaChars.includes(charKey)) structType = "flatNa";
            else if (currentLessonIdNum === 10 && semiWrapChars.includes(charKey)) structType = "semiWrap";
            else {
                if (flatChars.includes(charKey)) structType = "flat";
                else if (tallChars.includes(charKey)) structType = "tall";
                else if (leftSmallChars.includes(charKey)) structType = "leftSmall";
                else if (semiChars.includes(charKey)) structType = "semi";
                else if (obliqueHookChars.includes(charKey)) structType = "obliqueHook";
                else if (speechChars.includes(charKey)) structType = "speechRadical";
                else if (symmetryChars.includes(charKey)) structType = "symmetry";
                else if (diagonalChars.includes(charKey)) structType = "diagonal";
            }
            
            if (Math.random() > 0.3) { 
                var structList = DB.structure[structType] || DB.structure["general"];
                structureInfo = structList[Math.floor(Math.random() * structList.length)];
            }

            var closing = DB.closings[Math.floor(Math.random() * DB.closings.length)];
            var finalComment = opening + techDetail + (structureInfo ? " " + structureInfo : "") + " " + closing;
            document.getElementById('ai-comment').innerHTML = finalComment;
        }

        function finishAdjustReal() {
            var finalImg = document.getElementById('final-img');
            finalImg.src = document.getElementById('adjust-img').src;
            finalImg.style.transform = document.getElementById('adjust-img').style.transform;
            var v = document.getElementById('study-video');
            if(v) v.pause();
            var stamp = document.querySelector('.stamp');
            stamp.classList.remove('show');
            void stamp.offsetWidth;
            stamp.classList.add('show');
            switchPracticeStep('step-report');
        }
    </script>
</body>
</html>
